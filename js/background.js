// Generated by CoffeeScript 1.3.3
(function() {
  var broadcastState, buttonListener, findOrCreateTabProcess, processes, setTabButtonState, tabsListener;

  processes = {};

  findOrCreateTabProcess = function(tab) {
    var process;
    process = processes[tab.id];
    if (process == null) {
      process = new TabProcess({
        tab: tab,
        onStateChange: function(state) {
          setTabButtonState(tab, state);
          return broadcastState(tab, state);
        }
      });
      processes[tab.id] = process;
    }
    return process;
  };

  setTabButtonState = function(tab, state) {
    return chrome.browserAction.setIcon({
      path: "images/button_" + (state.replace('.', '_')) + ".png",
      tabId: tab.id
    });
  };

  broadcastState = function(tab, state) {
    var data;
    data = {
      name: 'stateChanged',
      state: state
    };
    return chrome.tabs.sendRequest(tab.id, data);
  };

  tabsListener = function(request, sender, sendResponse) {
    var process, state;
    process = findOrCreateTabProcess(sender.tab);
    switch (request.name) {
      case 'captured':
        return process.specs.add(request.data);
      case 'loaded':
        state = process.getState();
        setTabButtonState(sender.tab, state);
        return broadcastState(sender.tab, state);
      case 'named':
        process.specs.setName(request.specsName);
        return process.toNextState();
    }
  };

  chrome.extension.onRequest.addListener(tabsListener);

  buttonListener = function(tab) {
    var output, process;
    process = findOrCreateTabProcess(tab);
    process.toNextState();
    switch (process.getState()) {
      case 'generate':
        output = process.specs.generate();
        $('#clipboard').val(output).focus().select();
        document.execCommand('copy');
        return delete processes[process.id];
    }
  };

  chrome.browserAction.onClicked.addListener(buttonListener);

}).call(this);
